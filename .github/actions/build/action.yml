name: 'Build'
description: 'Composite action to build this cmake project'
inputs:
  cpm_source_cache:
    required: true
    type: string
  preset:
    description: 'Cmake preset'
    required: true
    type: string
  architecture:
    description: 'System architecture'
    required: true
    type: string
    default: 'x64'
  configuration:
    description: 'Build configuration'
    required: true
    type: string
    default: 'release'
  toolchain:
    description: 'Compiler toolchain'
    required: true
    type: string
outputs:
  preset_name:
    value: ${{ inputs.architecture }}-${{ inputs.toolchain }}-${{ inputs.configuration }}
  build_directory:
    value: ./out/build/${{ inputs.architecture }}-${{ inputs.toolchain }}-${{ inputs.configuration }}


runs:
  using: "composite"
  steps:
    - name: "CCache"
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ outputs.preset_name }}

    - name: "Cache CPM dependencies"
      uses: actions/cache@v4
      with:
        path: ${{ inputs.cpm_source_cache }}
        key: cpm-${{ hashFiles('**/*.cmake', '**/CMakeLists.txt') }}
        enableCrossOsArchive: true

    - name: "Install msvc"
      if: ${{inputs.toolchain == 'msvc'}}
      uses: ilammy/msvc-dev-cmd@v1

    - name: "Install CMake and Ninja"
      uses: lukka/get-cmake@latest

    - name: "Build"
      shell: bash
      run: |
        cmake --preset ${{ outputs.preset_name }}
        cmake --build ${{ outputs.build_directory }}
